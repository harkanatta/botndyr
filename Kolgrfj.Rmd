---
title: "Næstu skref"
author: "Valtýr"
date: "2023-01-03"
output: html_document
---

Nú hafa tegundir að mestu verið greindar úr botndýrasýnum í Kolgrafafirði frá árunum 2013-2017. Aðeins skeljar og spionidae-ormar í einstaka stöðvum urðu eftir en GVH greindi spionida ekki nánar

```{r pakkar, message=FALSE, warning=FALSE, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
Rpakkar <- c("tidyverse","benthos","worrms", "plyr", "data.table", "DT", "dplyr")
pacman::p_load(Rpakkar, character.only = TRUE)

#Sys.setlocale("LC_ALL", "Icelandic") # `Sys.setlocale` er hér fyrir íslenskar dagsetningar.
```



```{r innlestur}

##2013
t2013 <- read.csv(here::here("Kolgr2013",list.files(here::here("Kolgr2013"), pattern = "csv")),encoding="latin1")[ ,-c(1,2)] %>%
  pivot_longer(!Flokkun, names_to = "dolla", values_to = "N") %>% 
  na.omit(N) %>% 
  mutate(Artal = 2013)
#t2013 <- t2013[t2013$stod != "U1" & t2013$stod != "U2",] #Utanbrúarstöðvarnar teknar út 

##2014
t2014 <- read.csv(here::here("Kolgr2014",list.files(here::here("Kolgr2014"))),encoding="latin1") %>%
  pivot_longer(!Flokkun, names_to = "dolla", values_to = "N") %>% 
  na.omit(N) %>% 
  mutate(Artal = 2014)

##2015
t2015 <- read.csv(here::here("Kolgr2015",list.files(here::here("Kolgr2015"), pattern = "csv")),encoding="latin1") %>%
  pivot_longer(!Flokkun, names_to = "dolla", values_to = "N") %>% 
  na.omit(N) %>% 
  mutate(Artal = 2015)

##2017
t2017 <- read.csv(here::here("Kolgr2017",list.files(here::here("Kolgr2017"), pattern = "csv")),encoding="latin1") %>%
  pivot_longer(!Flokkun, names_to = "dolla", values_to = "N") %>% 
  na.omit(N) %>% 
  mutate(Artal = 2017)

GVH <- rbind(t2013,t2014,t2015,t2017) %>% 
   mutate(skipting = substr(dolla, nchar(dolla), nchar(dolla))) %>% #ná í súbbun og setja í sér dálk
    mutate(skipting = case_when(grepl("[[:alpha:]]",skipting) ~ 1,
                                TRUE ~ as.numeric(as.character(skipting))),
           dolla = substr(dolla,1,3),
           stod = substr(dolla,1,2),
           Nu = N*skipting) %>%
  dplyr::rename(id = dolla)

##2016
dataPath <- here::here("Kolgr2016")
datafiles <- list.files(path=dataPath, pattern = "csv", full.names = TRUE, recursive = T)
datafiles <- datafiles[-19]
classes <- c("character","integer", "factor", "character")

load_data <- function(dataPath, classes) { 
  tables <- lapply(datafiles, read.csv, colClasses=classes, na.strings=c("NA", ""))
  names(tables) <- substr(dirname( datafiles ),57,59)
  data.table::rbindlist(tables, idcol = "id" )
}

data <- load_data(dataPath, classes)

data$stod <- substr(data$id,1,2)
data$skipting <- gsub("¼|1/4|0.25",4,data$skipting) %>% 
  as.numeric() # laga misræmi í skráningu á súbbuninni
#data$Flokkun <- sapply(data$Flokkun, function(x) gsub("\\.|\\ sp|\\(p)|\\/.*","",x)) #Laga heitin. Eykur benthos::is_accepted(taxon = Flokkun) úr 432 í 522
#data$Flokkun <- str_to_sentence(data$Flokkun) #Stór stafur í byrjun heitis
data <- data[!is.na(data$N) & !is.na(data$Flokkun) & data$N!="NA",]  
gogn <- as.data.frame(data) %>% 
  ddply(.(Flokkun,id,N,skipting,stod),summarize, Artal=2016, Nu=sum(N*skipting)) %>% 
  select( Flokkun,id,N,Artal,skipting,stod,Nu)

########## Heild
allartalningar <- rbind(GVH,gogn)
#write.csv(allartalningar, "allartalningar.csv",na="", row.names = F, fileEncoding = "latin1")

```


```{r hreinsun}

df$Flokkun <-   sapply(allartalningar$Flokkun, function(x) gsub("\\ kemur líka Heteromastus filiformis|\\ Sipunculidea/|\\.|\\ TUNICATA EÐA FLEIRI?|\\ nýsestir|\\ ungviði|\\ ungv.|\\ ungv|\\ juv|\\ sp.|\\ sp|\\(p)|\\ ath","",x)) #Laga heitin. Eykur benthos::is_accepted(taxon = Flokkun) úr 432 í 522

         A <- c()
        
         for (i in unique(df$Flokkun)) {
           A[i] <- try(wm_name2id(name = i) )
         }
         A <- as.data.frame(A)
         A$flokkun <- row.names(A)
         DF <- merge(df,A, by.x="Flokkun", by.y="flokkun")
         DF$worms <- as.integer(as.character(DF$A)) #Öll heiti í remove_list tekin úr 'allartalningar' og sett í df
         
        

```




```{r taxa}

 DFekkina <- DF[!is.na(DF$worms),]
         B <- list()
         for (i in 1:length(DFekkina$worms)) {
           B[[i]] <-  wm_classification(DFekkina$worms[i])
         }
         df_list <- lapply(1:length(B), 
                           function(x) (pivot_wider(B[[x]][-1], names_from = rank, values_from = scientificname)))
         
         rass <- bind_rows(df_list)
         #print(rass,n=50)
         geggjad <- cbind(rass,DFekkina)


###Hreinsun

 
  remove_list <- paste(c("—Ssekkt",
                         "—ßekkt",
                         "Foraminifera",
                         "Götungar",
                         "Harpacticoida",
                         "Hydrozoa",
                         "Lirfur",
                         "lirfur",
                         "Skordýr",
                         "Ranaormur",
                         "Lirfurogdrasl",
                         "Bandormur",
                         "Lirfa",
                         "egg",
                         "Óþekkt",
                         "Rækjulirfa",
                         "Nematoda",
                         "Nemertea",
                         "Möttuldýr?",
                         "Porifera",
                         "rækjulirfa",
                         "Ostracoda"
                         ), collapse = '|')
  
  
  remove_ind <- lapply(strsplit(remove_list , "\\|")[[1]] , \(x) grep(x , allartalningar$Flokkun , fixed = T)) |> 
    unlist() |> 
    unique()
  df <- allartalningar[-remove_ind,]  #Öll heiti í remove_list tekin úr 'allartalningar' og sett í df
  

         A <- c()
        
         for (i in unique(df$Flokkun)) {
           A[i] <- try(wm_name2id(name = i) )
         }
         A <- as.data.frame(A)
         A$flokkun <- row.names(A)
         DF <- merge(df,A, by.x="Flokkun", by.y="flokkun")
         DF$worms <- as.integer(as.character(DF$A)) # Þau heiti sem fá ekki númer verða NA
         
         DFekkina <- DF[!is.na(DF$worms),]
         B <- list()
         for (i in 1:length(DFekkina$worms)) {print(i)
           B[[i]] <-  wm_classification(DFekkina$worms[i])
         }
         df_list <- lapply(1:length(B), 
                           function(x) (pivot_wider(B[[x]][-1], names_from = rank, values_from = scientificname)))
         
         rass <- bind_rows(df_list)
         #print(rass,n=50)
         #geggjad <- cbind(rass,DFekkina)
 
unique(DF$Flokkun[is.na(DF$worms)])
  
  
DF %>%
  mutate(Flokkun = case_when(
    str_detect(event_type, "Astartidae borealis") ~ "Astarte borealis",
    str_detect(event_type, "Exogone verrugera")  ~ "Exogone verugera",
    str_detect(event_type, "Möttuldýr") ~ "Tunicata",
    str_detect(event_type, "Campanulariidae sp")  ~ "Campanulariidae",
    str_detect(event_type, "Cardidae") ~ "Cardiidae",
    str_detect(event_type, "Cerastoderma ovale")  ~ "Parvicardium pinnulatum",
    str_detect(event_type, "Clinocardium cillaturn") ~ "Clinocardium ciliatum",
    str_detect(event_type, "Riots")  ~ "Riot",
    str_detect(event_type, "Cycloterus lumpus") ~ "Cyclopterus lumpus",
    str_detect(event_type, "Eteone longa ath")  ~ "Eteone longa",
    str_detect(event_type, "Gattyana cirrosa") ~ "Gattyana cirrhosa",
    str_detect(event_type, "Campanulariidae sp")  ~ "Campanulariidae",
    str_detect(event_type, "Cardidae") ~ "Cardiidae",
    str_detect(event_type, "Cerastoderma ovale")  ~ "Parvicardium pinnulatum",
    str_detect(event_type, "Clinocardium cillaturn") ~ "Clinocardium ciliatum",
    TRUE ~ event_type
    )
  )
         str_replace(DF, "[aeiou]", "-")
         Astarte borealis
         #Tunicata 
         #Exogone verrugera
         
DF %>%
  mutate(Flokkun = case_when(         
    str_detect(event_type, "Arenicolarina"       ~ "Arenicola marina",
    str_detect(event_type,"Clinocardium cillaturn"     ~ 
    str_detect(event_type,"Henricia sanguinolenta"     ~
    str_detect(event_type,"Möttuldýr?"                 ~
    str_detect(event_type,"Nuculana tenuis"            ~
    str_detect(event_type,"Phyllodoce maculata"        ~
    str_detect(event_type,"Praxillella m"              ~
    str_detect(event_type,"Skeljar"                    ~
    str_detect(event_type,"Terebellides benedi"        ~
    str_detect(event_type,"Tubificoides benedi"       ~
    str_detect(event_type,"Astartidae borealis"  ~
    str_detect(event_type,"Cycloterus lumpus"     ~
    str_detect(event_type,"lirfa"                 ~
    str_detect(event_type,"Musculus"              ~
    str_detect(event_type,"Nudibranch"            ~
    str_detect(event_type,"Plergoniuminosum"      ~
    str_detect(event_type,"Priapulus camelus"     ~
    str_detect(event_type,"spio"                  ~
    str_detect(event_type,"Terribellides kozloffi"~
    str_detect(event_type,"Tubificoides benedict" ~
    str_detect(event_type,"Campanulariidae sp"  ~
    str_detect(event_type,"Eteone longa ath"     ~
    str_detect(event_type,"Macoma calcaria"      ~
    str_detect(event_type,"Mya"                  ~
    str_detect(event_type,"Oligochaeta"          ~
    str_detect(event_type,"Plerugoniuminosissum" ~
    str_detect(event_type,"Priapulus candatus"   ~
    str_detect(event_type,"Spio"                 ~
    str_detect(event_type,"Terribellides stroemi"~
    str_detect(event_type,"Cardidae"                  ~
    str_detect(event_type,"Exogone verrugera"          ~
    str_detect(event_type,"Mediomastus filiformis"     ~
    str_detect(event_type,"Nephtiydae"                 ~
    str_detect(event_type,"Ophryotrocha cf Cosmetandra" ~
    str_detect(event_type,"Polydora"                   ~
    str_detect(event_type,"rækjulirfa"                 ~
    str_detect(event_type,"Sternapsis scutata"         ~
    str_detect(event_type,"Tubicoides benedi"     ~
    str_detect(event_type,"Cerastoderma ovale"    ~
    str_detect(event_type,"Gattyana cirrosa"       ~
    str_detect(event_type,"Möttuldýr"              ~
    str_detect(event_type,"Nepthys"                ~
    str_detect(event_type,"Opistobranchia"         ~
    str_detect(event_type,"Polynoida"              ~
    str_detect(event_type,"Serripes groenlandica"  ~
    str_detect(event_type,"Terebellidae"           ~
    str_detect(event_type,"Tubicoides kozloffi"    ~

         
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
